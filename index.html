<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Weather Service</title>
  <link href="https://unpkg.com/fundamental-styles" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">
</head>

<body>
  <div>
    <h2 class="fd-title fd-title--h2" id="info">No selected activities</h2>

    <h3 class="fd-title fd-title--h3">Latitude: <div id="lat"></div></h3>
    <h3 class="fd-title fd-title--h3">Longitude: <div id="long"></div></h3>
    <h3 class="fd-title fd-title--h3">DateTime: <div id="time"></div></h3>
    <h3 class="fd-title fd-title--h3">Temperature: <div id="temp"></div></h3>
    <h3 class="fd-title fd-title--h3">Relative Humidity: <div id="rel-hum"></div></h3>
    <h3 class="fd-title fd-title--h3">Wind Speed: <div id="wind"></div></h3>

  </div>
  <script src="https://unpkg.com/fsm-shell"></script>
  <script src="utils.js"></script>
  <script>

    // Import ShellSDK and events list from FSMShell global variable
    // see https://github.com/SAP/fsm-shell for more details.
    const { ShellSdk, SHELL_EVENTS } = FSMShell;

    // Display an error message if extension does not run within shell
    if (!ShellSdk.isInsideShell()) {
      updateTitle('Unable to reach shell event API');
    } else {
      // Initialise ShellSDK to connect with parent shell library
      const shellSdk = ShellSdk.init(parent, '*');

      // Initialise the extension by requesting the fsm context
      shellSdk.emit(SHELL_EVENTS.Version1.REQUIRE_CONTEXT, {

        clientIdentifier: '698ff0a3-1b95-4bed-9bec-072dea9a6ca6',
        clientSecret: '6b880d57-bde2-4643-9328-fed869adb0bb',

        auth: {
          response_type: 'token'  // request a user token within the context
        }
      });


      // Callback on fsm context response
      shellSdk.on(SHELL_EVENTS.Version1.REQUIRE_CONTEXT, (event) => {

        const {
          // extract required context from event content
          cloudHost,
          account,
          company,
          user,
          // extract authentication data from event content
          auth
        } = JSON.parse(event);

        // Access_token has a short life stpan and needs to be refreshed before expiring
        // Each extension need to implement its own strategy to fresh it.
        initializeRefreshTokenStrategy(shellSdk, auth);

        // Add a listenner expecting activityID
        shellSdk.onViewState('activityID', async activityID => {

          let response = await getWeather(cloudHost, account, company, activityID);

          updateTitle('Weather Information of the Selected Activity');
          updateUI(response);
        });
      });
    }
  </script>
</body>

</html>